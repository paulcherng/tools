# Maven ä¾è³´è¿½è¹¤èˆ‡é›¢ç·šæ‰“åŒ…å¢å¼·å·¥å…· (Maven Dependency Tracer & Offline Packager)

ä¸€å€‹å¼·å¤§çš„ Python è…³æœ¬ï¼Œç”¨æ–¼æ·±åº¦åˆ†æ Maven å°ˆæ¡ˆçš„ä¾è³´é—œä¿‚ï¼Œå»ºç«‹ä¸€å€‹æœ€å°åŒ–ä¸”å®Œæ•´çš„é›¢ç·š Maven å€‰åº«ï¼Œä¸¦æ™ºæ…§åœ°åˆ†æå’Œè§£æ±ºç¼ºå¤±çš„ä¾è³´å•é¡Œã€‚

This is a powerful Python script designed to deeply analyze Maven project dependencies, create a minimal and complete offline Maven repository, and intelligently analyze and resolve missing dependency issues.

[![Language](https://img.shields.io/badge/Language-Python%203-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)

## è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ (The Problem It Solves)

åœ¨ä¼æ¥­å…§éƒ¨ç¶²è·¯ã€ç”Ÿç”¢ç’°å¢ƒæˆ–ä»»ä½•ç„¡æ³•å­˜å–å¤–éƒ¨ Maven ä¸­å¤®å€‰åº«çš„é›¢ç·šç’°å¢ƒä¸­éƒ¨ç½² Java æ‡‰ç”¨ç¨‹å¼æ˜¯ä¸€é …æŒ‘æˆ°ã€‚å‚³çµ±æ–¹æ³•ï¼Œå¦‚ `mvn dependency:go-offline` æˆ–æ‰‹å‹•è¤‡è£½æ•´å€‹ `.m2` æ–‡ä»¶å¤¾ï¼Œå­˜åœ¨ä»¥ä¸‹ç¼ºé»ï¼š

1.  **æ•ˆç‡ä½ä¸‹**ï¼šè¤‡è£½æ•´å€‹ `.m2` æœƒåŒ…å«å¤§é‡èˆ‡ç•¶å‰å°ˆæ¡ˆç„¡é—œçš„ä¾è³´ã€‚
2.  **è³‡è¨Šä¸é€æ˜**ï¼šç•¶æ§‹å»ºå¤±æ•—æ™‚ï¼Œå¾ˆé›£è¿½è¹¤ä¸€å€‹é–“æ¥ä¾è³´ (transitive dependency) æ˜¯ç”±å“ªå€‹ç›´æ¥ä¾è³´å¼•å…¥çš„ã€‚
3.  **ç›²ç›®è™•ç†**ï¼šç„¡æ³•å€åˆ†ä¸€å€‹ç¼ºå¤±çš„ä¾è³´æ˜¯**å¿…è¦**çš„ (essential)ï¼Œé‚„æ˜¯**å¯é¸**çš„ (optional)ï¼Œå°è‡´é–‹ç™¼è€…èŠ±è²»å¤§é‡æ™‚é–“å»å°‹æ‰¾ä¸€å€‹å…¶å¯¦ä¸¦ä¸å½±éŸ¿ç·¨è­¯çš„ä¾è³´ã€‚
4.  **é…ç½®ç¹ç‘£**ï¼šéœ€è¦æ‰‹å‹•é…ç½®é›¢ç·šç’°å¢ƒçš„ `settings.xml` æ–‡ä»¶ã€‚

æœ¬å·¥å…·æ—¨åœ¨è§£æ±ºä»¥ä¸Šæ‰€æœ‰å•é¡Œï¼Œæä¾›ä¸€å€‹è‡ªå‹•åŒ–ã€æ™ºæ…§åŒ–ä¸”é€æ˜åŒ–çš„è§£æ±ºæ–¹æ¡ˆã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½ (Key Features)

*   **æ·±åº¦ä¾è³´éˆè¿½è¹¤**ï¼šé€é `mvn dependency:tree -Dverbose` å‘½ä»¤ï¼Œç²¾ç¢ºè¿½è¹¤æ¯å€‹ä¾è³´çš„å®Œæ•´å¼•å…¥éˆï¼Œæ¸…æ¥šäº†è§£æ¯å€‹ JAR åŒ…çš„ä¾†æºã€‚
*   **æ™ºæ…§åˆ†æç¼ºå¤±ä¾è³´**ï¼šè‡ªå‹•å°‡ç¼ºå¤±çš„ä¾è³´åˆ†é¡ç‚º**å¿…è¦ (essential)**ã€**å¯é¸ (optional)**ã€**é‹è¡Œæ™‚æä¾› (provided)**ã€**æ’ä»¶ (plugin)** æˆ– **ç‰ˆæœ¬è¡çª (conflict)**ï¼Œå¹«åŠ©æ‚¨å°ˆæ³¨æ–¼çœŸæ­£é‡è¦çš„å•é¡Œã€‚
*   **å¯¦éš›æ§‹å»ºé©—è­‰**ï¼šåœ¨åˆ†æå¾Œï¼Œå˜—è©¦åœ¨ç›®æ¨™å€‰åº«ä¸ŠåŸ·è¡Œ `mvn compile` å’Œ `mvn package`ï¼Œä»¥å¯¦éš›æ§‹å»ºçµæœé©—è­‰ä¾è³´çš„å®Œæ•´æ€§ï¼Œé¿å…ç†è«–åˆ†æèˆ‡ç¾å¯¦è„«ç¯€ã€‚
*   **è‡ªå‹•ç”Ÿæˆå ±å‘Šèˆ‡å»ºè­°**ï¼š
    *   åœ¨çµ‚ç«¯æ©Ÿä¸­æä¾›æ¸…æ™°çš„å½©è‰²æ‘˜è¦å ±å‘Šã€‚
    *   ç”Ÿæˆè©³ç´°çš„ `dependency-analysis-report.json` æ–‡ä»¶ï¼Œä¾›é€²ä¸€æ­¥åˆ†ææˆ–è‡ªå‹•åŒ–è™•ç†ã€‚
    *   å°ç¼ºå¤±çš„é—œéµä¾è³´æä¾›ä¿®å¾©å»ºè­°ï¼Œä¾‹å¦‚å°‹æ‰¾å¯ç”¨ç‰ˆæœ¬æˆ–ç”Ÿæˆä¸‹è¼‰è…³æœ¬ã€‚
*   **ä¸€éµç”Ÿæˆé›¢ç·šç’°å¢ƒé…ç½®**ï¼šè‡ªå‹•å‰µå»º `settings.xml` æ–‡ä»¶ï¼ŒæŒ‡å‘æ–°ç”Ÿæˆçš„é›¢ç·šå€‰åº«ï¼Œè®“æ‚¨å¯ä»¥ç«‹å³åœ¨é›¢ç·šç’°å¢ƒä¸­é€²è¡Œæ§‹å»ºã€‚
*   **ä¸¦è¡Œè™•ç†**ï¼šä½¿ç”¨å¤šåŸ·è¡Œç·’ä¸¦è¡Œè¤‡è£½ä¾è³´ï¼Œå¤§å¹…ç¸®çŸ­è™•ç†å¤§å‹å°ˆæ¡ˆçš„æ™‚é–“ã€‚
*   **è·¨å¹³å°æ”¯æ´**ï¼šè‡ªå‹•æª¢æ¸¬ä½œæ¥­ç³»çµ±ä¸¦æ‰¾åˆ°å¯ç”¨çš„ `mvn` å‘½ä»¤ã€‚

## âš™ï¸ é‹ä½œæµç¨‹ (How It Works)

è…³æœ¬çš„åŸ·è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **åˆ†æ (Analysis)**ï¼š
    *   åŸ·è¡Œ `mvn dependency:tree -Dverbose=true` ç²å–åŒ…å«å®Œæ•´ä¾è³´éˆã€è¡çªå’Œæ’é™¤ä¿¡æ¯çš„ä¾è³´æ¨¹ã€‚
    *   åŸ·è¡Œ `mvn help:effective-pom` åˆ†ææœ€çµ‚ç”Ÿæ•ˆçš„ POMï¼Œä»¥ç²å–ç”± `dependencyManagement` ç®¡ç†çš„ä¾è³´å’Œæ’ä»¶è³‡è¨Šã€‚
    *   è§£æå°ˆæ¡ˆçš„ `pom.xml` ä»¥è­˜åˆ¥ç›´æ¥ä¾è³´ã€‚
2.  **è¤‡è£½ (Copying)**ï¼š
    *   æ ¹æ“šåˆ†æçµæœï¼Œå»ºç«‹ä¸€ä»½éœ€è¦è¤‡è£½çš„ä¾è³´æ¸…å–®ï¼ˆå·²æ’é™¤çš„ä¾è³´æœƒè¢«è·³éï¼‰ã€‚
    *   ä½¿ç”¨å¤šåŸ·è¡Œç·’å¾**ä¾†æºå€‰åº«** (`source_repo`) ä¸¦è¡Œè¤‡è£½ä¾è³´æ–‡ä»¶åˆ°**ç›®æ¨™å€‰åº«** (`target_repo`)ã€‚
3.  **å ±å‘Šèˆ‡é©—è­‰ (Reporting & Verification)**ï¼š
    *   è¨˜éŒ„æ‰€æœ‰è¤‡è£½å¤±æ•—çš„ä¾è³´ã€‚
    *   å°‡ç¼ºå¤±çš„ä¾è³´é€²è¡Œåˆ†é¡ï¼Œä¸¦åœ¨æ§åˆ¶å°è¼¸å‡ºæ‘˜è¦ã€‚
    *   ï¼ˆå¯é¸ï¼‰åœ¨å°ˆæ¡ˆä¸­å˜—è©¦åŸ·è¡Œ `mvn compile` å’Œ `mvn package`ï¼Œä»¥é©—è­‰ç•¶å‰ä¾è³´æ˜¯å¦è¶³ä»¥æ”¯æŒæ§‹å»ºã€‚
4.  **ç”Ÿæˆç”¢ç‰© (Artifact Generation)**ï¼š
    *   åœ¨ç›®æ¨™å€‰åº«ç›®éŒ„ä¸‹ç”Ÿæˆ `dependency-analysis-report.json` è©³ç´°å ±å‘Šã€‚
    *   ç”Ÿæˆ `settings.xml` ä¾›é›¢ç·šç’°å¢ƒä½¿ç”¨ã€‚
    *   ç‚ºç¼ºå¤±çš„é—œéµä¾è³´ç”Ÿæˆä¸€å€‹ `download-missing-deps.sh` è…³æœ¬ç¯„æœ¬ï¼Œä»¥è¼”åŠ©ä¿®å¾©ã€‚

## ğŸš€ ä½¿ç”¨æŒ‡å— (Usage)

### å‰ææ¢ä»¶ (Prerequisites)

*   Python 3.6+
*   Apache Maven å·²å®‰è£ä¸¦é…ç½®åœ¨ç³»çµ±çš„ `PATH` ç’°å¢ƒè®Šæ•¸ä¸­ã€‚

### å®‰è£ (Installation)

ç›´æ¥ä¸‹è¼‰è…³æœ¬å³å¯ï¼Œç„¡éœ€é¡å¤–å®‰è£ã€‚å»ºè­°å°‡è…³æœ¬å‘½åç‚º `maven_dependency_tracer.py` ä¸¦è³¦äºˆåŸ·è¡Œæ¬Šé™ã€‚

```bash
# å‡è¨­è…³æœ¬åç¨±ç‚º maven_dependency_tracer.py
chmod +x maven_dependency_tracer.py
```

### å‘½ä»¤æ ¼å¼

```bash
./maven_dependency_tracer.py <project_path> <source_repo> <target_repo> [options]
```

### åƒæ•¸èªªæ˜

*   `project_path`: ã€å¿…å¡«ã€‘ä½ çš„ Maven å°ˆæ¡ˆæ ¹ç›®éŒ„è·¯å¾‘ã€‚
*   `source_repo`: ã€å¿…å¡«ã€‘ä¾†æº Maven å€‰åº«è·¯å¾‘ã€‚é€šå¸¸æ˜¯ä½ çš„æœ¬åœ°é–‹ç™¼æ©Ÿä¸Šçš„ `~/.m2/repository`ã€‚
*   `target_repo`: ã€å¿…å¡«ã€‘ç›®æ¨™é›¢ç·šå€‰åº«è·¯å¾‘ã€‚è…³æœ¬æœƒåœ¨æ­¤è·¯å¾‘ä¸‹å‰µå»ºä¸€å€‹ä¹¾æ·¨çš„å€‰åº«ã€‚
*   `--verbose`, `-v`: é¡¯ç¤ºè©³ç´°çš„åŸ·è¡Œæ—¥èªŒã€‚
*   `--threads <N>`, `-j <N>`: è¨­ç½®ä¸¦è¡Œè¤‡è£½ä¾è³´çš„åŸ·è¡Œç·’æ•¸é‡ (é è¨­: 4)ã€‚
*   `--analyze-only`: åªé€²è¡Œåˆ†æä¸¦ç”Ÿæˆå ±å‘Šï¼Œä¸åŸ·è¡Œä»»ä½•æ–‡ä»¶è¤‡è£½æ“ä½œã€‚
*   `--copy-missing-only`: å‡è¨­ä½ ä¹‹å‰å·²ç¶“é‹è¡Œéä¸€æ¬¡ï¼Œæ­¤é¸é …æœƒå˜—è©¦åªè¤‡è£½ä¸Šæ¬¡åˆ†æå ±å‘Šä¸­æ¨™è¨˜ç‚ºç¼ºå¤±çš„ä¾è³´ã€‚

### å¯¦éš›ç¯„ä¾‹

å‡è¨­ä½ çš„å°ˆæ¡ˆåœ¨ `/path/to/my-app`ï¼Œä½ æƒ³åˆ©ç”¨æœ¬åœ°çš„ Maven ç·©å­˜ (`~/.m2/repository`) ä¾†å‰µå»ºä¸€å€‹ä½æ–¼ `/tmp/offline-repo` çš„é›¢ç·šå€‰åº«ã€‚

```bash
./maven_dependency_tracer.py /path/to/my-app ~/.m2/repository /tmp/offline-repo -j 8
```

åŸ·è¡Œå¾Œï¼Œä½ å°‡åœ¨ `/tmp/offline-repo` ç›®éŒ„ä¸‹å¾—åˆ°ï¼š
*   ä¸€å€‹åŒ…å«æ‰€æœ‰å¿…è¦ä¾è³´çš„ Maven å€‰åº«çµæ§‹ã€‚
*   ä¸€å€‹ `settings.xml` æ–‡ä»¶ã€‚
*   ä¸€å€‹ `dependency-analysis-report.json` è©³ç´°å ±å‘Šã€‚
*   ï¼ˆå¦‚æœéœ€è¦ï¼‰ä¸€å€‹ `download-missing-deps.sh` è…³æœ¬ã€‚

### åœ¨é›¢ç·šç’°å¢ƒä¸­ä½¿ç”¨

1.  å°‡æ•´å€‹ `target_repo` ç›®éŒ„ï¼ˆä¾‹å¦‚ä¸Šä¾‹ä¸­çš„ `/tmp/offline-repo`ï¼‰æ‰“åŒ…ä¸¦å‚³è¼¸åˆ°ä½ çš„é›¢ç·šä¼ºæœå™¨ã€‚
2.  åœ¨é›¢ç·šä¼ºæœå™¨ä¸Šï¼Œé€²å…¥ä½ çš„å°ˆæ¡ˆç›®éŒ„ï¼Œä½¿ç”¨ `-s` åƒæ•¸æŒ‡å®š `settings.xml` é€²è¡Œæ§‹å»ºï¼š

```bash
# -s æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œ--offline å¼·åˆ¶é›¢ç·šæ¨¡å¼
mvn -s /path/to/offline-repo/settings.xml clean package --offline
```

## ğŸ”¬ ç¨‹å¼ç¢¼åˆ†æ (Code Analysis)

è©²è…³æœ¬çš„æ ¸å¿ƒæ˜¯ `MavenDependencyTracer` é¡ï¼Œå…¶ä¸»è¦æ–¹æ³•è·è²¬å¦‚ä¸‹ï¼š

*   `__init__(...)`: åˆå§‹åŒ–è·¯å¾‘ã€è®Šæ•¸å’Œ Maven å‘½ä»¤ã€‚
*   `_find_maven_command()`: è·¨å¹³å°å°‹æ‰¾å¯ç”¨çš„ `mvn` å‘½ä»¤ã€‚
*   `analyze_dependencies_with_tracing()`: å”èª¿æ•´å€‹ä¾è³´åˆ†ææµç¨‹çš„å…¥å£é»ã€‚
*   `_analyze_dependency_tree_verbose()`: åŸ·è¡Œ `mvn dependency:tree` ä¸¦èª¿ç”¨è§£æå™¨ï¼Œé€™æ˜¯ç²å–å®Œæ•´ä¾è³´éˆçš„é—œéµã€‚
*   `_parse_verbose_dependency_tree(...)`: ä½¿ç”¨æ­£å‰‡è¡¨é”å¼è§£æ `dependency:tree` çš„è©³ç´°è¼¸å‡ºï¼Œæå–ä¾è³´ã€ç¯„åœã€ç‰ˆæœ¬ã€è¡çªç­‰è³‡è¨Šã€‚
*   `_analyze_effective_pom()`: åŸ·è¡Œ `mvn help:effective-pom` ä»¥æ•ç²ç”±çˆ¶ POM æˆ– `dependencyManagement` å½±éŸ¿çš„ä¾è³´ã€‚
*   `copy_all_dependencies_with_tracking(...)`: ä½¿ç”¨ `ThreadPoolExecutor` ä¸¦è¡Œè¤‡è£½æ‰€æœ‰æœ‰æ•ˆä¾è³´ã€‚
*   `analyze_missing_dependencies()`: å°è¤‡è£½å¤±æ•—çš„ä¾è³´é€²è¡Œåˆ†é¡ï¼Œæ˜¯æ­¤å·¥å…·çš„æ™ºæ…§æ ¸å¿ƒã€‚
*   `verify_with_actual_build()`: åŸ·è¡Œ `mvn compile` / `package` é€²è¡Œå¯¦éš›é©—è­‰ï¼Œæä¾›æœ€çµ‚çš„ä¿¡å¿ƒä¿è­‰ã€‚
*   `generate_enhanced_report()`: æ•´åˆæ‰€æœ‰åˆ†æçµæœï¼Œç”Ÿæˆæœ€çµ‚çš„æ§åˆ¶å°å ±å‘Šå’Œ JSON æ–‡ä»¶ã€‚
*   `_generate_recommendations(...)`: æ ¹æ“šåˆ†æçµæœæä¾›å¯è¡Œçš„ä¿®å¾©å»ºè­°ã€‚
*   `create_offline_settings_xml()`: æ ¹æ“šç›®æ¨™å€‰åº«è·¯å¾‘å‹•æ…‹ç”Ÿæˆ `settings.xml` æ–‡ä»¶ã€‚

## ğŸ“œ æˆæ¬Š (License)

æœ¬å°ˆæ¡ˆæ¡ç”¨ [MIT License](LICENSE) æˆæ¬Šã€‚
